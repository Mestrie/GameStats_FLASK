{% extends "base.html" %}

{% block title %}Detalhes - {{ detalhes.name or "Jogo Desconhecido" }}{% endblock %}

{% block content %}
<h1 class="text-center text-4xl font-bold mb-8">{{ detalhes.name or "Jogo Desconhecido" }}</h1>

<!-- SEÇÃO DE DETALHES DO JOGO (IGDB) - Exibição de Capa, Nota, Gênero e Plataformas -->
<section class="game-details my-8 p-6 bg-white shadow-xl rounded-xl flex flex-col md:flex-row gap-8">
    
    <!-- Capa e Nota -->
    <div class="md:w-1/3 flex flex-col items-center">
        <!-- Usa a imagem_url que foi tratada no Python -->
        <img src="{{ detalhes.imagem_url }}" alt="Capa de {{ detalhes.name or 'Jogo' }}" class="rounded-lg shadow-2xl w-full max-w-xs mb-6 border-4 border-gray-100 transition duration-300 hover:scale-[1.02]">
        
        {% if detalhes.total_rating %}
        <div class="rating-box bg-blue-600 text-white p-4 rounded-full text-2xl font-extrabold shadow-md">
            Nota Média: {{ "%.1f" | format(detalhes.total_rating) }} / 100
        </div>
        <p class="text-sm text-gray-500 mt-2">Baseado em {{ detalhes.total_rating_count or 0 }} avaliações</p>
        {% else %}
        <p class="text-gray-500 font-semibold mt-4">Nota Média Indisponível (Sem dados suficientes)</p>
        {% endif %}
    </div>

    <!-- Resumo e Informações Técnicas -->
    <div class="md:w-2/3">
        <h2 class="text-3xl font-semibold mb-4 border-b-2 pb-2 text-gray-800">Resumo do Jogo</h2>
        <p class="text-gray-700 leading-relaxed mb-6">{{ detalhes.summary or "Nenhuma descrição detalhada disponível para este jogo." }}</p>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 bg-gray-50 p-4 rounded-lg border">
            <div>
                <h3 class="font-bold text-lg text-blue-700 mb-1">Gêneros:</h3>
                {% if detalhes.genres %}
                    <!-- Mapeia a lista de dicionários para exibir apenas os nomes -->
                    <p class="text-gray-600">{{ detalhes.genres | map(attribute='name') | join(', ') }}</p>
                {% else %}
                    <p class="text-gray-600 italic">Não especificado</p>
                {% endif %}
            </div>
            <div>
                <h3 class="font-bold text-lg text-blue-700 mb-1">Plataformas:</h3>
                {% if detalhes.platforms %}
                    <!-- Mapeia a lista de dicionários para exibir apenas os nomes -->
                    <p class="text-gray-600">{{ detalhes.platforms | map(attribute='name') | join(', ') }}</p>
                {% else %}
                    <p class="text-gray-600 italic">Não especificado</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Formulário de simulação de avaliação (Mantido da sua versão original) -->
        <div class="mt-8 p-4 border-2 border-dashed border-gray-300 rounded-lg bg-yellow-50">
             <h2 class="text-xl font-bold text-yellow-800 mb-3">Sua Avaliação (Simulação)</h2>
             <form action="#" method="POST" class="flex items-center space-x-4">
                 <label for="nota" class="font-medium text-gray-700">Nota (1 a 5):</label>
                 <input type="number" id="nota" name="nota" min="1" max="5" required class="p-2 border border-gray-300 rounded-lg w-24 focus:ring-blue-500 focus:border-blue-500">
                 <button type="submit" class="px-4 py-2 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition duration-150">Enviar Avaliação</button>
             </form>
        </div>
        
    </div>
</section>

<!-- SEÇÃO DE DASHBOARD DE STREAMS (TWITCH) - CONTEINER DOS GRÁFICOS -->
<section class="twitch-analysis mt-12 pt-6 border-t">
    <h2 class="text-3xl font-bold mb-8 text-gray-800">Streams Ativas na Twitch</h2>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        
        <!-- Contêiner do Gráfico de Visualizadores -->
        <div class="chart-container bg-white p-6 rounded-xl shadow-2xl">
            <h3 class="text-xl font-semibold mb-4 text-center text-gray-700">Visualizadores por Stream</h3>
            <canvas id="visualizadorChart"></canvas>
        </div>

        <!-- Contêiner do Gráfico de Avaliações Simuladas -->
        <div class="chart-container bg-white p-6 rounded-xl shadow-2xl">
            <h3 class="text-xl font-semibold mb-4 text-center text-gray-700">Avaliação Média (Simulada)</h3>
            <canvas id="avaliacaoChart"></canvas>
        </div>
    </div>
</section>

<!-- INJEÇÃO DE VARIÁVEIS E CARREGAMENTO DE SCRIPTS -->
<script>
    // Define variáveis globais (window.gameId, window.gameName) 
    // que o script externo 'dashboard.js' precisa para fazer a chamada à API.
    window.gameId = "{{ game_id }}"; 
    window.gameName = "{{ detalhes.name or 'o jogo' }}";
    
    // O Jinja renderiza as variáveis aqui (ex: window.gameId = "5555";)
    // permitindo que o JS externo as acesse.
</script>

<!-- Carrega Chart.js para renderização de gráficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
<!-- Carrega o script externo para a lógica principal -->
<script src="{{ url_for('static', filename='dashboard.js') }}"></script>

{% endblock %}